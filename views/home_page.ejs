<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SpyThere - Home</title>
  <link rel="stylesheet" href="home_page.css">
</head>

<body class="home-page">

  <!-- Include Header -->
  <%- include('partials/header') %>

  <!-- Page layout: Sidebar + Main Content -->
  <div class="app-layout">

    <!-- Include Sidebar (Navbar) -->
    <%- include('partials/navbar') %>

    <!-- Main Content Section -->
    <div class="main-content">
      <h2>Spy Here!</h2>

      <!-- Todo List Section -->
      <div class="todo-container">
        <ul>
          <% posts.forEach(post => { %>
            <li data-post-id="<%= post.id %>">
              <strong><%= post.username %></strong>
              <%= post.value %>
              <div class="post-reactions">
                <div class="like-wrapper">
                  <img src="/assets/Like_Icon.png" alt="Like" class="reaction-icon like-btn" data-liked="false">
                  <span class="like-count" data-post-id="<%= post.id %>">0</span>
                </div>
                <div class="comment-wrapper">
                  <img src="/assets/Comment_Icon.png" alt="Comment" class="reaction-icon comment-btn">
                  <span class="comment-count" data-post-id="<%= post.id %>">0</span>
                </div>
                <img src="/assets/Share_Icon.png" alt="Share" class="reaction-icon">
              </div>
            </li>
          <% }) %>
        </ul>
      </div>

      <!-- Modal for Adding Post -->
      <div id="post-modal">
        <div id="modal-content">
          <form action="/submit-post" method="post" id="post-form">
            <h1>Create to Web</h1>
            <textarea name="post" id="post" placeholder="What's on your mind..."></textarea>
            <div id="modal-btns">
              <button id="close-modal-btn" class="modal-btn" type="button">Cancel</button>
              <input type="submit" value="Post" id="post-content-btn" class="modal-btn">
            </div>
          </form>
        </div>
      </div>
      
      <!-- Modal for Comments -->
      <div class="comment-modal">
        <div class="comment-modal-content">
          <button class="close-comment-modal">×</button>
          <h3>Comments <span class="modal-comment-count">0</span></h3>
          
          <!-- Comment Input Section -->
          <div class="comment-input-section">
            <textarea placeholder="Write a comment..."></textarea>
            <div class="comment-actions">
              <button type="button" class="modal-btn">Cancel</button>
              <button type="button" class="modal-btn">Post Comment</button>
            </div>
          </div>
          
          <div class="comment-divider"></div>
          
          <!-- Comment List Section -->
          <div class="comment-list-section">
            <div class="loading-comments">Loading comments</div>
          </div>
        </div>
      </div>
      
      <!-- Modal for Likes -->
      <div class="like-modal">
        <div class="like-modal-content">
          <button class="close-like-modal">×</button>
          <h3>Likes <span class="modal-like-count">0</span></h3>
          
          <div class="like-divider"></div>
          
          <!-- Like List Section -->
          <div class="like-list-section">
            <div class="loading-likes">Loading likes</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="/scripts/index.js"></script>
  <script>
    // Comment Modal Functionality
    document.addEventListener('DOMContentLoaded', function() {
      const commentBtns = document.querySelectorAll('.comment-btn');
      const commentModal = document.querySelector('.comment-modal');
      const closeCommentBtn = document.querySelector('.close-comment-modal');
      const cancelCommentBtn = document.querySelector('.comment-actions .modal-btn:first-child');
      const commentListSection = document.querySelector('.comment-list-section');
      const modalCommentCount = document.querySelector('.modal-comment-count');
      
      // Current post being commented on
      let currentPostId = null;
      
      // Open comment modal when comment icon is clicked
      commentBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const postItem = this.closest('li');
          currentPostId = postItem.dataset.postId;
          console.log('Opening comments for post:', currentPostId);
          commentModal.style.display = 'block';
          
          // Clear previous comments
          commentListSection.innerHTML = '';
          
          // Show loading indicator
          const loadingMsg = document.createElement('div');
          loadingMsg.className = 'loading-comments';
          loadingMsg.textContent = 'Loading comments';
          commentListSection.appendChild(loadingMsg);
          
          // Fetch comments from server for this post
          fetchComments(currentPostId);
        });
      });
      
      // Fetch comments from the server
      async function fetchComments(postId) {
        try {
          console.log('Fetching comments for post:', postId);
          // Encode the postId to handle special characters in the URL
          const encodedPostId = encodeURIComponent(postId);
          const response = await fetch(`/api/comments/${encodedPostId}`);
          
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Server returned ${response.status}: ${errorText}`);
          }
          
          const data = await response.json();
          console.log('Comments received:', data);
          
          // Clear loading message
          commentListSection.innerHTML = '';
          
          // Update comment counts
          const commentCount = data.comments ? data.comments.length : 0;
          updateCommentCount(postId, commentCount);
          modalCommentCount.textContent = `(${commentCount})`;
          
          if (data.comments && data.comments.length > 0) {
            // Display comments
            data.comments.forEach(comment => {
              const commentElement = createCommentElement(comment.author, comment.text);
              commentListSection.appendChild(commentElement);
            });
          } else {
            // Show no comments message
            const noCommentsMsg = document.createElement('div');
            noCommentsMsg.className = 'no-comments-message';
            noCommentsMsg.textContent = 'No comments yet. Be the first to comment!';
            commentListSection.appendChild(noCommentsMsg);
          }
        } catch (error) {
          console.error('Error fetching comments:', error);
          commentListSection.innerHTML = `<div class="error-message">Failed to load comments: ${error.message}</div>`;
          modalCommentCount.textContent = '(0)';
        }
      }
      
      // Helper function to create comment element
      function createCommentElement(author, text) {
        const commentElement = document.createElement('div');
        commentElement.className = 'comment-item';
        commentElement.innerHTML = `
          <div class="comment-author">${author}</div>
          <div class="comment-text">${text}</div>
        `;
        return commentElement;
      }
      
      // Update comment count for a specific post
      function updateCommentCount(postId, count) {
        const countElement = document.querySelector(`.comment-count[data-post-id="${postId}"]`);
        if (countElement) {
          countElement.textContent = count;
        }
      }
      
      // Close comment modal
      function closeCommentModal() {
        commentModal.style.display = 'none';
        currentPostId = null;
      }
      
      closeCommentBtn.addEventListener('click', closeCommentModal);
      cancelCommentBtn.addEventListener('click', closeCommentModal);
      
      // Close modal when clicking outside
      commentModal.addEventListener('click', function(e) {
        if (e.target === commentModal) {
          closeCommentModal();
        }
      });
      
      // Post comment button
      const postCommentBtn = document.querySelector('.comment-actions .modal-btn:last-child');
      postCommentBtn.addEventListener('click', async function() {
        const commentTextarea = document.querySelector('.comment-input-section textarea');
        const commentText = commentTextarea.value;
        
        if (commentText.trim() === '' || !currentPostId) {
          console.log('Empty comment or no post ID');
          return;
        }
        
        console.log('Posting comment to post:', currentPostId);
        
        try {
          // Show posting indicator
          postCommentBtn.disabled = true;
          postCommentBtn.textContent = 'Posting...';
          
          // Send comment to server
          const response = await fetch('/api/comments', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              postId: currentPostId,
              text: commentText
            })
          });
          
          console.log('Response status:', response.status);
          
          if (!response.ok) {
            const errorData = await response.text();
            console.error('Server error response:', errorData);
            throw new Error(`Server returned ${response.status}: ${errorData}`);
          }
          
          const newComment = await response.json();
          console.log('Comment posted successfully:', newComment);
          
          // Clear any "no comments" message
          const noCommentsMsg = commentListSection.querySelector('.no-comments-message');
          if (noCommentsMsg) {
            commentListSection.removeChild(noCommentsMsg);
          }
          
          // Add to UI
          const newCommentElement = createCommentElement(newComment.author, newComment.text);
          commentListSection.prepend(newCommentElement);
          
          // Clear the input
          commentTextarea.value = '';
          
          // Update comment count
          const currentCount = parseInt(modalCommentCount.textContent.replace(/[()]/g, '')) || 0;
          const newCount = currentCount + 1;
          modalCommentCount.textContent = `(${newCount})`;
          updateCommentCount(currentPostId, newCount);
          
        } catch (error) {
          console.error('Error posting comment:', error);
          alert(`Failed to post comment: ${error.message}`);
        } finally {
          // Reset button state
          postCommentBtn.disabled = false;
          postCommentBtn.textContent = 'Post Comment';
        }
      });
      
      // Initialize comment counts on page load
      function initializeCommentCounts() {
        const commentCountElements = document.querySelectorAll('.comment-count');
        commentCountElements.forEach(async countElement => {
          const postId = countElement.dataset.postId;
          if (postId) {
            try {
              const encodedPostId = encodeURIComponent(postId);
              const response = await fetch(`/api/comments/${encodedPostId}`);
              
              if (response.ok) {
                const data = await response.json();
                const commentCount = data.comments ? data.comments.length : 0;
                countElement.textContent = commentCount;
              }
            } catch (error) {
              console.error(`Error fetching comment count for post ${postId}:`, error);
            }
          }
        });
      }
      
      // Initialize comment counts when page loads
      initializeCommentCounts();
      
      // Like Modal Functionality
      const likeBtns = document.querySelectorAll('.like-btn');
      const likeModal = document.querySelector('.like-modal');
      const closeLikeBtn = document.querySelector('.close-like-modal');
      const likeListSection = document.querySelector('.like-list-section');
      const modalLikeCount = document.querySelector('.modal-like-count');
      
      // Current post being viewed for likes
      let currentLikePostId = null;
      
      // Toggle like status when like icon is clicked
      likeBtns.forEach(btn => {
        btn.addEventListener('click', async function() {
          const postItem = this.closest('li');
          const postId = postItem.dataset.postId;
          const isLiked = this.dataset.liked === 'true';
          
          // Toggle like status
          this.dataset.liked = !isLiked;
          
          // Change icon based on like status
          if (!isLiked) {
            this.src = '/assets/Liked_Icon.png';
            this.alt = 'Unlike';
          } else {
            this.src = '/assets/Like_Icon.png';
            this.alt = 'Like';
          }
          
          // Update like count
          try {
            const response = await fetch('/api/likes', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                postId: postId,
                liked: !isLiked
              })
            });
            
            if (!response.ok) {
              throw new Error(`Server returned ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Like updated:', data);
            
            // Update like count in UI
            updateLikeCount(postId, data.likeCount);
          } catch (error) {
            console.error('Error updating like:', error);
            // Revert UI changes on error
            this.dataset.liked = isLiked;
            this.src = isLiked ? '/assets/Liked_Icon.png' : '/assets/Like_Icon.png';
            this.alt = isLiked ? 'Unlike' : 'Like';
          }
        });
      });
      
      // Show likes modal when clicking on like count
      document.querySelectorAll('.like-count').forEach(countElement => {
        countElement.addEventListener('click', function() {
          const postId = this.dataset.postId;
          currentLikePostId = postId;
          likeModal.style.display = 'block';
          
          // Clear previous likes
          likeListSection.innerHTML = '';
          
          // Show loading indicator
          const loadingMsg = document.createElement('div');
          loadingMsg.className = 'loading-likes';
          loadingMsg.textContent = 'Loading likes';
          likeListSection.appendChild(loadingMsg);
          
          // Fetch likes from server for this post
          fetchLikes(postId);
        });
      });
      
      // Fetch likes from the server
      async function fetchLikes(postId) {
        try {
          console.log('Fetching likes for post:', postId);
          const encodedPostId = encodeURIComponent(postId);
          const response = await fetch(`/api/likes/${encodedPostId}`);
          
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Server returned ${response.status}: ${errorText}`);
          }
          
          const data = await response.json();
          console.log('Likes received:', data);
          
          // Clear loading message
          likeListSection.innerHTML = '';
          
          // Update like counts
          const likeCount = data.likes ? data.likes.length : 0;
          updateLikeCount(postId, likeCount);
          modalLikeCount.textContent = `(${likeCount})`;
          
          if (data.likes && data.likes.length > 0) {
            // Display likes
            data.likes.forEach(like => {
              const likeElement = createLikeElement(like.username);
              likeListSection.appendChild(likeElement);
            });
          } else {
            // Show no likes message
            const noLikesMsg = document.createElement('div');
            noLikesMsg.className = 'no-likes-message';
            noLikesMsg.textContent = 'No likes yet. Be the first to like!';
            likeListSection.appendChild(noLikesMsg);
          }
        } catch (error) {
          console.error('Error fetching likes:', error);
          likeListSection.innerHTML = `<div class="error-message">Failed to load likes: ${error.message}</div>`;
          modalLikeCount.textContent = '(0)';
        }
      }
      
      // Helper function to create like element
      function createLikeElement(username) {
        const likeElement = document.createElement('div');
        likeElement.className = 'like-item';
        likeElement.innerHTML = `
          <div class="like-username">${username}</div>
        `;
        return likeElement;
      }
      
      // Update like count for a specific post
      function updateLikeCount(postId, count) {
        const countElement = document.querySelector(`.like-count[data-post-id="${postId}"]`);
        if (countElement) {
          countElement.textContent = count;
        }
      }
      
      // Close like modal
      function closeLikeModal() {
        likeModal.style.display = 'none';
        currentLikePostId = null;
      }
      
      closeLikeBtn.addEventListener('click', closeLikeModal);
      
      // Close modal when clicking outside
      likeModal.addEventListener('click', function(e) {
        if (e.target === likeModal) {
          closeLikeModal();
        }
      });
      
      // Initialize like counts and states on page load
      function initializeLikes() {
        const likeCountElements = document.querySelectorAll('.like-count');
        const likeBtns = document.querySelectorAll('.like-btn');
        
        // Process each post
        likeCountElements.forEach(async (countElement, index) => {
          const postId = countElement.dataset.postId;
          if (postId) {
            try {
              const encodedPostId = encodeURIComponent(postId);
              const response = await fetch(`/api/likes/${encodedPostId}`);
              
              if (response.ok) {
                const data = await response.json();
                
                // Update count
                const likeCount = data.likes ? data.likes.length : 0;
                countElement.textContent = likeCount;
                
                // Check if current user liked this post
                if (data.userLiked) {
                  const likeBtn = likeBtns[index];
                  likeBtn.src = '/assets/Liked_Icon.png';
                  likeBtn.alt = 'Unlike';
                  likeBtn.dataset.liked = 'true';
                }
              }
            } catch (error) {
              console.error(`Error fetching like data for post ${postId}:`, error);
            }
          }
        });
      }
      
      // Initialize likes when page loads
      initializeLikes();
    });
  </script>
</body>

</html>
